<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø Wellness Rezerwacje</title>
    
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <meta name="theme-color" content="#4CAF50">
    
    <style>
        /* CSS DLA WYGLƒÑDU */
        :root {
            --primary-color: #4CAF50; 
            --secondary-color: #81C784; 
            --background-color: #F8FAF7; 
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --taken-color: #F44336; 
            --reserved-by-user-color: #FFC107; 
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 25px; 
            background: var(--background-color); 
            color: var(--text-color);
        }
        h2, h3, h4 { color: var(--primary-color); }

        .card { 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); 
            margin-bottom: 25px; 
        }

        input, select { 
            padding: 12px; 
            margin: 8px 0; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        button { 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            cursor: pointer; 
            width: 100%; 
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        button:hover { background: #388E3C; }

        .hidden { display: none; }
        
        /* Kalendarz */
        .day-column { border: 1px solid #e0e0e0; }
        .slot { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px; 
            border-bottom: 1px solid #f0f0f0; 
            align-items: center; 
            border-radius: 4px;
            margin: 5px 0;
            font-weight: 500;
        }

        .slot.taken { background-color: #FEEAEA; color: var(--taken-color); }
        .slot.my-reservation { background-color: #FFFDE7; color: var(--reserved-by-user-color); }
        .slot.free { background-color: #E8F5E9; color: var(--primary-color); cursor: pointer; }
        .slot.free:hover { background-color: #DCEFE0; }
        .slot-actions { display: flex; gap: 8px; }
        
        .slot.taken button, .slot.my-reservation button { width: auto; padding: 6px 12px; font-size: 0.9em; }

        #logout-btn { 
            background: #6c757d; 
            width: auto; 
            display: inline-block;
            margin-top: 10px;
        }

        /* Kontrola Admina */
        #admin-controls > div {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #e0e0e0;
        }

        #admin-report-controls button {
            background-color: #007bff;
            margin-right: 5px;
            width: auto;
        }

        #admin-report-controls select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #admin-reservation-form button {
            background-color: #FFA000;
        }
        
        /* Styl dla tabeli raportu */
        #entries-report-table th, #entries-report-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }
        #entries-report-table th {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="card">
        <h2>Wellness Center - Rezerwacje</h2>
        
        <div style="text-align: right; margin-bottom: 15px;">
             <input type="checkbox" id="admin-checkbox" onchange="toggleAdminPassword()">
             <label for="admin-checkbox" style="font-weight: bold; color: var(--primary-color);">Logowanie Admina</label>
        </div>
        
        <input type="text" id="code-input" placeholder="Wpisz kod apartamentu (np. 1001) lub Login Admina (np. AGNIESZKA)">
        
        <div id="password-field" class="hidden">
            <input type="password" id="pass-input" placeholder="Has≈Ço administratora">
        </div>
        
        <button onclick="handleLogin()">Wejd≈∫ do Strefy</button>
        <p id="login-error" style="color:var(--taken-color); display:none; text-align: center; margin-top: 15px;"></p>
    </div>

    <div id="app-screen" class="hidden">
        <div class="card">
            <h3>Witaj, <span id="user-name"></span>!</h3>
            <p style="font-size: 0.9em; color: #666;">Limit: 1 rezerwacja w 2-dniowym oknie. Anulowanie do 60 minut przed czasem.</p>
            <button onclick="logout()" id="logout-btn">Wyloguj</button>
            
            <div id="admin-controls" class="hidden">
                <h4>‚öôÔ∏è Panel Administratora</h4>

                <div id="admin-reservation-form">
                    <strong>Rezerwacja dla Apartamentu:</strong>
                    <select id="apartment-select">
                        <option value="">-- Wybierz Apartament --</option>
                    </select>
                    <button onclick="toggleAdminBookingMode()" style="background:orange;">Aktywuj Rezerwacjƒô Admina</button>
                    <p id="admin-mode-status" style="color:var(--taken-color); margin-top:5px; font-weight:bold;"></p>
                </div>

                <div id="admin-report-controls">
                    <strong>Raporty:</strong>
                    <button onclick="downloadReport('full_csv')" style="background:#007bff;">Pe≈Çny Raport (CSV)</button>
                    <button onclick="showEntriesReport()" style="background:#5cb85c;">Raport Wej≈õƒá (Tabela)</button>
                </div>
            </div>
        </div>
        
        <div id="entries-report-container" class="hidden card" style="margin-top: 20px;">
            <h4>üìä Raport Wej≈õƒá (Zrealizowane rezerwacje)</h4>
            <table id="entries-report-table" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                </table>
        </div>

        <div id="calendar-container"></div>
    </div>

    <script>
        let currentUser = null;
        let adminBookingMode = false; 
        
        // Rejestracja Service Workera dla PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registered: ', registration);
                })
                .catch(registrationError => {
                    console.log('ServiceWorker registration failed: ', registrationError);
                });
            });
        }
        
        function calculateEndTime(startTime) {
            const [hours, minutes] = startTime.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, minutes + 50, 0); 
            
            const endHours = String(date.getHours()).padStart(2, '0');
            const endMinutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${endHours}:${endMinutes}`;
        }
        
        function toggleAdminPassword() {
            const isAdmin = document.getElementById('admin-checkbox').checked;
            const passField = document.getElementById('password-field');
            if (isAdmin) {
                passField.classList.remove('hidden');
            } else {
                passField.classList.add('hidden');
                document.getElementById('pass-input').value = ''; 
            }
        }

        async function handleLogin() {
            const code = document.getElementById('code-input').value;
            const isAdminChecked = document.getElementById('admin-checkbox').checked;
            const password = isAdminChecked ? document.getElementById('pass-input').value : '';

            // NOWY ENDPOINT NETLIFY
            const response = await fetch('/.netlify/functions/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, password })
            });

            const data = await response.json();

            if (data.success) {
                currentUser = data;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('user-name').innerText = data.name;
                
                if (data.role === 'admin') {
                    document.getElementById('admin-controls').classList.remove('hidden');
                    loadApartments(); 
                } else {
                     document.getElementById('admin-controls').classList.add('hidden');
                }
                loadSlots();
            } else {
                const err = document.getElementById('login-error');
                err.innerText = data.message;
                err.style.display = 'block';
            }
        }
        
        async function loadApartments() {
            // NOWY ENDPOINT NETLIFY
            const response = await fetch('/.netlify/functions/apartments');
            const apartments = await response.json();
            const select = document.getElementById('apartment-select');
            
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            apartments.forEach(apt => {
                const option = document.createElement('option');
                option.value = apt.id;
                option.text = apt.apartment_name;
                select.add(option);
            });
        }
        
        function toggleAdminBookingMode() {
            const select = document.getElementById('apartment-select');
            const status = document.getElementById('admin-mode-status');
            
            if (adminBookingMode) {
                adminBookingMode = false;
                status.innerText = '';
                select.disabled = false;
                alert('Tryb rezerwacji Admina DEZAKTYWOWANY.');
            } else {
                if (!select.value) {
                    alert('Proszƒô najpierw wybraƒá apartament, dla kt√≥rego ma byƒá rezerwacja.');
                    return;
                }
                adminBookingMode = true;
                status.innerText = `AKTYWNY TRYB REZERWACJI dla: ${select.options[select.selectedIndex].text}. Kliknij slot, aby zarezerwowaƒá.`;
                select.disabled = true;
                alert('Tryb rezerwacji Admina AKTYWOWANY. Kliknij zielony slot w kalendarzu.');
            }
            loadSlots(); 
        }

        async function loadSlots() {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '<div class="card">≈Åadowanie...</div>';
            
            // NOWY ENDPOINT NETLIFY
            const response = await fetch(`/.netlify/functions/slots?user_id=${currentUser.user_id}`);
            const days = await response.json();
            
            container.innerHTML = ''; 

            days.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-column card';
                
                let html = `<h4>${day.date}</h4>`;
                
                day.slots.forEach(slot => {
                    let slotClass = '';
                    let slotContent = '';
                    let actionsHtml = '';
                    
                    const fullTimeRange = `${slot.time} - ${calculateEndTime(slot.time)}`;
                    
                    if (slot.is_free) {
                        slotClass = 'free';
                        slotContent = `<span>${fullTimeRange} - Wolne</span>`;
                        
                        let buttonAction = `book('${day.date}', '${slot.time}')`;
                        let buttonStyle = `background: var(--secondary-color);`;
                        
                        if (currentUser.role === 'admin' && adminBookingMode) {
                            buttonAction = `bookAdmin('${day.date}', '${slot.time}')`;
                            buttonStyle = `background: orange;`;
                        } else if (currentUser.role === 'admin' && !adminBookingMode) {
                             buttonAction = `alert('Aktywuj tryb rezerwacji admina, aby zarezerwowaƒá dla apartamentu.')`;
                             buttonStyle = `background: #6c757d;`;
                        }
                        
                        actionsHtml = `<button onclick="${buttonAction}" style="width:auto; padding:6px 12px; ${buttonStyle}">Rezerwuj</button>`;
                    
                    } else if (slot.is_current_user_reservation) {
                        slotClass = 'my-reservation';
                        slotContent = `<span>${fullTimeRange} - Twoja Rezerwacja</span>`;
                        actionsHtml = `<button onclick="cancel('${day.date}', '${slot.time}')" style="width:auto; padding:6px 12px; background: #dc3545;">Anuluj</button>`;
                    
                    } else {
                        // Slot zajƒôty
                        slotClass = 'taken';
                        const reservedBy = currentUser.role === 'admin' ? ` (${slot.reserved_by})` : "";
                        slotContent = `<span>${fullTimeRange} - Zajƒôte${reservedBy}</span>`;
                        actionsHtml = '';
                        
                        // Przycisk anulowania dla admina
                        if (currentUser.role === 'admin' && slot.reservation_id) {
                            actionsHtml += `<button onclick="adminCancel(${slot.reservation_id}, '${slot.reserved_by}', '${fullTimeRange}')" style="width:auto; padding:6px 12px; background: #673AB7; margin-left: 5px;">Anuluj (A)</button>`;
                        }
                    }

                    html += `<div class="slot ${slotClass}">
                                ${slotContent}
                                <div class="slot-actions">${actionsHtml}</div>
                             </div>`;
                });
                
                dayDiv.innerHTML = html;
                container.appendChild(dayDiv);
            });
        }
        
        async function book(date, time) {
             const fullTimeRange = `${time} - ${calculateEndTime(time)}`;
             if (!confirm(`Potwierd≈∫ rezerwacjƒô: ${date} godz. ${fullTimeRange}?`)) return;

            // NOWY ENDPOINT NETLIFY
            const response = await fetch('/.netlify/functions/book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.user_id,
                    role: currentUser.role,
                    date: date,
                    time: time,
                })
            });

            const result = await response.json();
            
            if (result.success) {
                let msg = result.message;
                // Wy≈õwietlenie kodu PIN (TTlock)
                if (result.pin) {
                    msg += `\n\nKOD DOSTƒòPU: ${result.pin}`;
                }
                alert(msg);
                loadSlots();
            } else {
                alert('B≈ÇƒÖd: ' + result.message);
            }
        }
        
        async function bookAdmin(date, time) {
            const select = document.getElementById('apartment-select');
            const target_user_id = select.value;
            const apartmentName = select.options[select.selectedIndex].text;
            
            const fullTimeRange = `${time} - ${calculateEndTime(time)}`;
            if (!confirm(`ADMIN: Czy na pewno zarezerwowaƒá ${fullTimeRange} dnia ${date} dla: ${apartmentName}?`)) return;

            // NOWY ENDPOINT NETLIFY
            const response = await fetch('/.netlify/functions/book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.user_id,
                    role: currentUser.role,
                    date: date,
                    time: time,
                    target_user_id: target_user_id 
                })
            });

            const result = await response.json();
            
            if (result.success) {
                let msg = `Rezerwacja dla ${apartmentName} udana!`;
                 // Wy≈õwietlenie kodu PIN (TTlock)
                if (result.pin) {
                    msg += `\n\nKOD DOSTƒòPU: ${result.pin}`;
                }
                alert(msg);
                loadSlots();
            } else {
                alert('B≈ÇƒÖd: ' + result.message);
            }
        }
        
        async function cancel(date, time) {
            const fullTimeRange = `${time} - ${calculateEndTime(time)}`;
            if (!confirm(`UWAGA: Anulowaƒá rezerwacjƒô: ${date} godz. ${fullTimeRange}? Wymagane 60 min marginesu.`)) return;

            // NOWY ENDPOINT NETLIFY
            const response = await fetch('/.netlify/functions/cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.user_id,
                    date: date,
                    time: time
                })
            });

            const result = await response.json();
            
            if (result.success) {
                alert('Pomy≈õlnie anulowano!');
                loadSlots();
            } else {
                alert('B≈ÇƒÖd anulowania: ' + result.message);
            }
        }
        
        async function adminCancel(reservationId, apartmentName, fullTimeRange) {
            if (!confirm(`ADMINISTRATOR: Anulowaƒá rezerwacjƒô ID ${reservationId} (${fullTimeRange}) dla apartamentu: ${apartmentName}? Ta akcja zostanie zapisana.`)) return;
            
            // NOWY ENDPOINT NETLIFY
            const response = await fetch('/.netlify/functions/admin_cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reservation_id: reservationId
                })
            });

            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                loadSlots(); 
            } else {
                alert('B≈ÇƒÖd anulowania przez Admina: ' + result.message);
            }
        }

        function logout() {
            currentUser = null;
            adminBookingMode = false;
            // Mo≈ºna dodaƒá bardziej zaawansowane czyszczenie stanu, ale prze≈Çadowanie wystarczy
            location.reload(); 
        }

        async function showEntriesReport() {
            const container = document.getElementById('entries-report-container');
            const table = document.getElementById('entries-report-table');
            table.innerHTML = '<tr><td colspan="20">≈Åadowanie raportu...</td></tr>';
            container.classList.remove('hidden');

            try {
                // NOWY ENDPOINT NETLIFY
                const response = await fetch('/.netlify/functions/report_entries');
                const result = await response.json();

                if (!result.success) {
                    table.innerHTML = `<tr><td colspan="20" style="color: var(--taken-color);">B≈ÇƒÖd: ${result.message}</td></tr>`;
                    return;
                }

                const data = result.table_data;
                const apts = result.apartments;
                
                // Nag≈Ç√≥wki (ROK i MIESIƒÑC, MIESIƒÑC, APARTAMENTY 1-18)
                let headerHtml = `<thead><tr><th>ROK i MIESIƒÑC</th><th>MIESIƒÑC</th>`;
                apts.forEach(apt => {
                    // Skracanie nazwy do "APT X" dla lepszego widoku w tabeli
                    headerHtml += `<th>${apt.replace('APARTAMENT ', 'APT ')}</th>`;
                });
                headerHtml += `</tr></thead>`;
                
                // Cia≈Ço tabeli (ilo≈õƒá wej≈õƒá)
                let bodyHtml = '<tbody>';
                data.forEach(row => {
                    bodyHtml += `<tr><td>${row.ROK_MIESIƒÑC}</td><td>${row.MIESIƒÑC}</td>`;
                    apts.forEach(apt => {
                        bodyHtml += `<td style="text-align: center;">${row[apt] || 0}</td>`;
                    });
                    bodyHtml += `</tr>`;
                });
                bodyHtml += '</tbody>';

                table.innerHTML = headerHtml + bodyHtml;

            } catch (error) {
                console.error("Error loading entries report:", error);
                table.innerHTML = `<tr><td colspan="20" style="color: var(--taken-color);">B≈ÇƒÖd komunikacji: Sprawd≈∫ konsolƒô przeglƒÖdarki.</td></tr>`;
            }
        }

        function downloadReport(type) {
            if (type === 'full_csv') {
                // NOWY ENDPOINT NETLIFY
                const url = '/.netlify/functions/report_full';
                window.open(url, '_blank'); 
            } else {
                 alert('Nieznany typ raportu.');
            }
        }
    </script>
</body>
</html>